{{ 'component-slider.css' | asset_url | stylesheet_tag }}
{{ 'custom-collection-list.css' | asset_url | stylesheet_tag }}

<section
  id="CollectionGrid-{{ section.id }}"
  class="collection-grid section-{{ section.id }}"
  data-autoscroll-delay="{{ section.settings.auto_scroll_delay }}"
  style="
    --arrow-color: {{ section.settings.arrow_color }};
    --arrow-bg: {{ section.settings.arrow_bg_color }};
    --title-overlay-color: {{ section.settings.title_overlay_color }};
  ">
  {%- liquid
    assign columns_mobile_int = section.settings.columns_mobile | plus: 0
    assign columns_desktop_int = section.settings.columns_desktop | plus: 0

    assign collection_cards_count = 0
    for block in section.blocks
      if block.settings.collection != blank
        assign collection_cards_count = collection_cards_count | plus: 1
      endif
    endfor

    assign show_mobile_slider = false
    if section.settings.swipe_on_mobile and collection_cards_count > columns_mobile_int
      assign show_mobile_slider = true
    endif

    assign show_desktop_slider = false
    if section.settings.enable_desktop_slider and collection_cards_count > columns_desktop_int
      assign show_desktop_slider = true
    endif

    assign show_slider_controls = false
    if show_mobile_slider or show_desktop_slider
      assign show_slider_controls = true
    endif

    assign desktop_columns_static = columns_desktop_int
    if collection_cards_count > 0 and collection_cards_count < columns_desktop_int
      assign desktop_columns_static = collection_cards_count
    endif
  -%}

  <div class="collection-grid__inner page-width">
    {% if section.settings.heading != blank %}
      <h2 class="collection-grid__heading h1" style="color: {{ section.settings.heading_color }}">
        {{ section.settings.heading }}
      </h2>
    {% endif %}

    <slider-component class="collection-grid__slider-component slider-mobile-gutter{% if show_desktop_slider %} slider-component-desktop{% endif %}">
      <ul
        id="Slider-{{ section.id }}"
        class="
          collection-grid__slider
          grid
          grid--{{ section.settings.columns_desktop }}-col-desktop
          grid--{{ section.settings.columns_mobile }}-col-tablet-down
          {% if show_mobile_slider or show_desktop_slider %} slider{% endif %}
          {% if show_mobile_slider %} slider--tablet grid--peek{% endif %}
          {% if show_desktop_slider %} slider--desktop{% endif %}
        "
        role="list"
        aria-label="{{ 'general.slider.name' | t }}"
        style="
          --desktop-columns: {{ columns_desktop_int }};
          --desktop-columns-static: {{ desktop_columns_static }};
          --mobile-columns: {{ columns_mobile_int }};
        ">
        {% for block in section.blocks %}
          {% assign collection = block.settings.collection %}
          {% if collection != blank %}
            {% assign card_title = block.settings.category | default: collection.title %}
            <li
              id="Slide-{{ section.id }}-{{ forloop.index }}"
              class="grid__item{% if show_mobile_slider or show_desktop_slider %} slider__slide{% endif %}"
              {{ block.shopify_attributes }}>
              <div class="collection-card" style="
                  --card-bg: {{ block.settings.card_bg }};
                  --btn-bg: {{ block.settings.button_color }};
                  --btn-color: {{ block.settings.button_font_color }};
                  --card-radius: {{ section.settings.card_border_radius }}px;
                  --btn-radius: {{ section.settings.button_border_radius }}px;
                ">
                {% assign img = block.settings.custom_image | default: collection.featured_image %}
                {% assign ratio = 100 %}
                {% if img != blank and img.aspect_ratio > 0 %}
                  {% assign ratio = 1 | divided_by: img.aspect_ratio | times: 100 %}
                {% endif %}

                <div class="collection-card__image-wrapper" style="--ratio: {{ ratio }}%;">
                  {% if img != blank %}
                    {{ img | image_url: width: 800 | image_tag: loading: 'lazy', class: 'collection-card__image' }}
                  {% else %}
                    {{ 'collection-apparel-1' | placeholder_svg_tag: 'collection-card__image collection-card__image--placeholder' }}
                  {% endif %}

                  {% if card_title != blank %}
                    <div class="collection-card__title-overlay collection-card__title-overlay--{{ section.settings.title_overlay_position }}">
                      <h3 class="collection-card__title collection-card__title--overlay">
                        {{ card_title }}
                      </h3>
                    </div>
                  {% endif %}
                </div>

                <div class="collection-card__content">
                  {% if block.settings.description != blank %}
                    <p class="collection-card__description">{{ block.settings.description }}</p>
                  {% endif %}

                  <a href="{{ collection.url }}" class="collection-card__button">
                    {{ section.settings.button_text }} &rarr;
                  </a>

                  {% if section.settings.show_product_count %}
                    <span class="collection-card__count">{{ collection.products_count }} Products</span>
                  {% endif %}
                </div>
              </div>
            </li>
          {% endif %}
        {% endfor %}
      </ul>

      {% if show_slider_controls %}
        <div class="slider-buttons no-js-hidden">
          <button
            type="button"
            class="slider-button slider-button--prev"
            name="previous"
            aria-label="{{ 'general.slider.previous_slide' | t }}"
            aria-controls="Slider-{{ section.id }}">
            {% render 'icon-caret' %}
          </button>
          <div class="slider-counter caption">
            <span class="slider-counter--current">1</span>
            <span aria-hidden="true"> / </span>
            <span class="visually-hidden">{{ 'general.slider.of' | t }}</span>
            <span class="slider-counter--total">{{ collection_cards_count }}</span>
          </div>
          <button
            type="button"
            class="slider-button slider-button--next"
            name="next"
            aria-label="{{ 'general.slider.next_slide' | t }}"
            aria-controls="Slider-{{ section.id }}">
            {% render 'icon-caret' %}
          </button>
        </div>
      {% endif %}
    </slider-component>
  </div>
</section>

{% if section.settings.enable_auto_scroll and show_slider_controls %}
  <script>
    (() => {
      const section = document.getElementById('CollectionGrid-{{ section.id }}');
      if (!section || section.dataset.autoscrollInitialized === 'true') return;
      section.dataset.autoscrollInitialized = 'true';

      const sliderComponent = section.querySelector('.collection-grid__slider-component');
      const slider = section.querySelector('#Slider-{{ section.id }}');
      const nextButton = section.querySelector('.slider-button--next');

      if (!sliderComponent || !slider || !nextButton) return;
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

      const delaySeconds = Number(section.dataset.autoscrollDelay);
      const delayMs = Number.isFinite(delaySeconds) ? Math.max(2, delaySeconds) * 1000 : 4000;
      let intervalId = null;

      const canAutoScroll = () => {
        if (document.hidden) return false;
        if (slider.scrollWidth <= slider.clientWidth + 2) return false;
        return window.getComputedStyle(nextButton).display !== 'none';
      };

      const advanceSlide = () => {
        if (!canAutoScroll()) return;
        if (nextButton.hasAttribute('disabled')) {
          slider.scrollTo({ left: 0, behavior: 'smooth' });
        } else {
          nextButton.click();
        }
      };

      const startAutoScroll = () => {
        if (intervalId || !canAutoScroll()) return;
        intervalId = window.setInterval(advanceSlide, delayMs);
      };

      const stopAutoScroll = () => {
        if (!intervalId) return;
        window.clearInterval(intervalId);
        intervalId = null;
      };

      const onMouseEnter = () => stopAutoScroll();
      const onMouseLeave = () => startAutoScroll();
      const onFocusIn = () => stopAutoScroll();
      const onFocusOut = () => startAutoScroll();
      const onTouchStart = () => stopAutoScroll();
      const onVisibilityChange = () => {
        if (document.hidden) {
          stopAutoScroll();
        } else {
          startAutoScroll();
        }
      };
      const onResize = () => {
        stopAutoScroll();
        startAutoScroll();
      };
      const onSectionUnload = (event) => {
        if (event.detail.sectionId != '{{ section.id }}') return;

        stopAutoScroll();
        sliderComponent.removeEventListener('mouseenter', onMouseEnter);
        sliderComponent.removeEventListener('mouseleave', onMouseLeave);
        sliderComponent.removeEventListener('focusin', onFocusIn);
        sliderComponent.removeEventListener('focusout', onFocusOut);
        sliderComponent.removeEventListener('touchstart', onTouchStart);
        document.removeEventListener('visibilitychange', onVisibilityChange);
        window.removeEventListener('resize', onResize);
        document.removeEventListener('shopify:section:unload', onSectionUnload);
      };

      sliderComponent.addEventListener('mouseenter', onMouseEnter);
      sliderComponent.addEventListener('mouseleave', onMouseLeave);
      sliderComponent.addEventListener('focusin', onFocusIn);
      sliderComponent.addEventListener('focusout', onFocusOut);
      sliderComponent.addEventListener('touchstart', onTouchStart, { passive: true });
      document.addEventListener('visibilitychange', onVisibilityChange);
      window.addEventListener('resize', onResize);
      document.addEventListener('shopify:section:unload', onSectionUnload);

      startAutoScroll();
    })();
  </script>
{% endif %}

{% schema %}
  {
    "name": "Collection Showcase",
    "settings": [
      {
        "type": "inline_richtext",
        "id": "heading",
        "label": "Heading",
        "default": "Shop by Category"
      },
      {
        "type": "color",
        "id": "heading_color",
        "label": "Heading color",
        "default": "#121212"
      },
      {
        "type": "color",
        "id": "arrow_color",
        "label": "Arrow color",
        "default": "#1f1f1f"
      },
      {
        "type": "color",
        "id": "arrow_bg_color",
        "label": "Arrow background",
        "default": "#ffffff"
      },
      {
        "type": "header",
        "content": "Title on image"
      },
      {
        "type": "select",
        "id": "title_overlay_position",
        "label": "Collection name position",
        "options": [
          {
            "value": "top-left",
            "label": "Top left"
          },
          {
            "value": "top-center",
            "label": "Top center"
          },
          {
            "value": "top-right",
            "label": "Top right"
          },
          {
            "value": "center-left",
            "label": "Center left"
          },
          {
            "value": "center-center",
            "label": "Center center"
          },
          {
            "value": "center-right",
            "label": "Center right"
          },
          {
            "value": "bottom-left",
            "label": "Bottom left"
          },
          {
            "value": "bottom-center",
            "label": "Bottom center"
          },
          {
            "value": "bottom-right",
            "label": "Bottom right"
          }
        ],
        "default": "bottom-left"
      },
      {
        "type": "color",
        "id": "title_overlay_color",
        "label": "Collection name color",
        "default": "#ffffff"
      }, {
        "type": "range",
        "id": "card_border_radius",
        "min": 0,
        "max": 24,
        "step": 2,
        "unit": "px",
        "label": "Card border radius",
        "default": 12
      }, {
        "type": "range",
        "id": "button_border_radius",
        "min": 0,
        "max": 24,
        "step": 2,
        "unit": "px",
        "label": "Button border radius",
        "default": 6
      }, {
        "type": "inline_richtext",
        "id": "button_text",
        "label": "Button text",
        "default": "View All"
      }, {
        "type": "checkbox",
        "id": "show_product_count",
        "label": "Show product count",
        "default": true
      }, {
        "type": "select",
        "id": "columns_mobile",
        "label": "Mobile columns",
        "options": [
          {
            "value": "1",
            "label": "1"
          }, {
            "value": "2",
            "label": "2"
          }
        ],
        "default": "1"
      }, {
        "type": "range",
        "id": "columns_desktop",
        "min": 2,
        "max": 6,
        "step": 1,
        "default": 4,
        "label": "Desktop columns"
      }, {
        "type": "checkbox",
        "id": "swipe_on_mobile",
        "default": true,
        "label": "Enable swipe on mobile"
      }, {
        "type": "checkbox",
        "id": "enable_desktop_slider",
        "default": false,
        "label": "Enable desktop slider"
      }, {
        "type": "header",
        "content": "Auto scroll"
      }, {
        "type": "checkbox",
        "id": "enable_auto_scroll",
        "default": false,
        "label": "Enable auto scroll"
      }, {
        "type": "range",
        "id": "auto_scroll_delay",
        "min": 2,
        "max": 10,
        "step": 1,
        "unit": "s",
        "label": "Auto scroll delay",
        "default": 4
      }
    ],
    "blocks": [
      {
        "type": "collection_card",
        "name": "Collection Card",
        "settings": [
          {
            "type": "collection",
            "id": "collection",
            "label": "Collection"
          },
          {
            "type": "inline_richtext",
            "id": "category",
            "label": "Category Name"
          },
          {
            "type": "textarea",
            "id": "description",
            "label": "Description"
          },
          {
            "type": "image_picker",
            "id": "custom_image",
            "label": "Custom Image For Collection"
          }, {
            "type": "color",
            "id": "card_bg",
            "label": "Card Background",
            "default": "#ffffff"
          }, {
            "type": "color",
            "id": "button_color",
            "label": "Button Color",
            "default": "#dc3545"
          }, {
            "type": "color",
            "id": "button_font_color",
            "label": "Button font color",
            "default": "#ffffff"
          }
        ]
      }
    ],
    "presets": [
      {
        "name": "Custom Collection List",
        "blocks": [
          {
            "type": "collection_card"
          }, {
            "type": "collection_card"
          }, {
            "type": "collection_card"
          }, {
            "type": "collection_card"
          }
        ]
      }
    ]
  }
{% endschema %}
